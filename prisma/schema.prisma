// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// O Enum define as regras estritas dos cargos (como as leis dos Reinos)
enum Role {
  USER
  ADMIN
  SUPERADMIN
  MASTER // O teu acesso exclusivo de Criador
}

model User {
  id          String    @id @default(cuid())
  name        String?
  email       String?   @unique
  password    String?   // Onde vai ficar o hash do bcrypt
  role        Role      @default(USER)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Material {
  id                String   @id @default(cuid())
  descricao         String
  medidas           String?  
  
  // --- AS NOVAS GAVETAS DO MOTOR (Preparação para a Hilti e Filtros) ---
  referenciaInterna String?  // Para o código da Hilti/Interno (O QR Code vai ler isto!)
  categoria         String?  // Ex: "Parafuso", "Viga", "Consumível"
  norma             String?  // Ex: "EN 15048"
  diametro          String?  // Ex: "M10", "IPE200"
  comprimento       String?  // Ex: "30mm", "6m"
  tratamento        String?  // Ex: "Zincado", "Galvanizado"
  classe            String?  // Ex: "8.8", "10.9"
  fotoUrl           String?  // Preparação para as futuras fotos
  fichaUrl          String?  // Preparação para os PDFs
  // ----------------------------------------------------------------------

  quantidade        Float    @default(0)
  unidade           String?  @default("un") // Coloquei um padrão "un" para não dar erro se ficar vazio
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  obras             MaterialObra[]

  @@map("materiais") 
}

model Obra {
  id          String    @id @default(cuid())
  nome        String    
  localizacao String?   
  estado      String    @default("EM_CURSO") 
  dataInicio  DateTime  @default(now())
  dataFim     DateTime? 
  
  // Campos financeiros
  orcamento   Float?    
  custoTotal  Float     @default(0) 

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relações
  materiais     MaterialObra[]
  documentos    Documento[]
  registosHoras RegistoHoras[]

  @@map("obras")
}

// Tabela de ligação: Regista a saída de material para a obra
model MaterialObra {
  id          String   @id @default(cuid())
  quantidade  Float    
  dataRegisto DateTime @default(now())

  obraId      String
  obra        Obra     @relation(fields: [obraId], references: [id], onDelete: Cascade)

  materialId  String
  material    Material @relation(fields: [materialId], references: [id])

  @@map("materiais_obra")
}

// Tabela para o repositório de documentos
model Documento {
  id              String   @id @default(cuid())
  nomeOriginal    String   
  caminhoFicheiro String   
  tamanho         Int      
  tipo            String   
  categoria       String

  // A NOSSA GAVETA NOVA PARA O DINHEIRO (Opcional, porque uma Planta não tem valor)
  valor           Float?   @default(0)

  dataUpload      DateTime @default(now())

  obraId          String
  obra            Obra     @relation(fields: [obraId], references: [id], onDelete: Cascade)

  @@map("documentos")
}

// Representa qualquer pessoa da empresa
model Funcionario {
  id          String   @id @default(cuid())
  nome        String
  
  // A NOSSA NOVA GAVETA: Ligação à tabela do Organograma!
  cargoId     String?
  cargo       CargoOrganograma? @relation(fields: [cargoId], references: [id])
  
  custoHora   Float    @default(0) 
  
  // Histórico de horas trabalhadas em qualquer obra
  horas       RegistoHoras[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("funcionarios")
}

// A Folha de Horas Diária que o Chefe preenche
model RegistoHoras {
  id            String   @id @default(cuid())
  data          DateTime @default(now())
  horas         Float    // Mudámos de 'quantidade' para 'horas' para não confundir com materiais
  descricao     String?  

  // Quem é o trabalhador
  funcionarioId String
  funcionario   Funcionario @relation(fields: [funcionarioId], references: [id], onDelete: Cascade)

  // Em que obra foi
  obraId        String
  obra          Obra        @relation(fields: [obraId], references: [id], onDelete: Cascade)

  // Quem validou as horas no terreno
  registadoPor  String?  

  @@map("registos_horas")
}

// O mapa rígido do teu orga.drawio!
model CargoOrganograma {
  id              String   @id @default(cuid())
  
  // Ex: "Departamento de Produção"
  departamento    String   
  
  // Ex: "Equipa Fábrica" (Para manter a tua hierarquia intacta)
  subDepartamento String?  
  
  // Ex: "Serralheiros" ou "Coordenador de Soldadura"
  nome            String   @unique 
  
  // Identifica se é o líder do departamento (para futuras aprovações de tickets)
  isChefia        Boolean  @default(false) 
  
  // Uma cor visual para as etiquetas no ecrã (Odoo style visual, mas Teku style rules)
  cor             String   @default("#2563eb")

  // Os trabalhadores colados a esta caixa do organograma
  funcionarios    Funcionario[]

  @@map("cargos_organograma")
}